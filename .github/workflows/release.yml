name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Full Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Run all tests
        run: |
          npm run test:unit
          npm run test:integration
          bash tests/test-runner.sh --mode=mock
        timeout-minutes: 15

  build-cli:
    name: Build CLI Package
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Pack npm package
        run: npm pack

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: '*.tgz'
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [test, build-cli]
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download npm package
        uses: actions/download-artifact@v7
        with:
          name: npm-package

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: changelog
        run: |
          # Try to extract this version's changelog from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            # Get content between this version and next version header
            sed -n "/## \[${{ steps.get_version.outputs.VERSION }}\]/,/## \[/p" CHANGELOG.md | \
              sed '$d' > /tmp/release-notes.md
            
            # If empty, use a default message
            if [ ! -s /tmp/release-notes.md ]; then
              echo "Release ${{ steps.get_version.outputs.VERSION }}" > /tmp/release-notes.md
              echo "" >> /tmp/release-notes.md
              echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> /tmp/release-notes.md
            fi
          else
            echo "Release ${{ steps.get_version.outputs.VERSION }}" > /tmp/release-notes.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.get_version.outputs.VERSION }}
          body_path: /tmp/release-notes.md
          files: |
            *.tgz
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'alpha') || contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Future: Publish to npm
  # Uncomment when ready to publish
  #
  # publish-npm:
  #   name: Publish to npm
  #   runs-on: ubuntu-latest
  #   needs: create-release
  #   if: "!contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')"
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         registry-url: 'https://registry.npmjs.org'
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Build
  #       run: npm run build
  #
  #     - name: Publish to npm
  #       run: npm publish
  #       env:
  #         NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  announce-release:
    name: Announce Release
    runs-on: ubuntu-latest
    needs: create-release
    if: success()
    
    steps:
      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Release announcement
        run: |
          echo "ðŸŽ‰ MailGoat v${{ steps.get_version.outputs.VERSION }} has been released!"
          echo "Download: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
